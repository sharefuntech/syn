<html>
<head>
  <!--[if lte IE 8]>
    <link href='//api.tiles.mapbox.com/mapbox.js/v1.2.0/mapbox.ie.css' rel='stylesheet' />
  <![endif]-->
  <link rel="stylesheet" href="css/leaflet-black.css">
  <link rel="stylesheet" href="../../../../lib/leafletMarkerCluster/MarkerCluster.Default.css">
    <link rel="stylesheet" href="../../../../lib/leafletMarkerCluster/MarkerCluster.css">
    <link rel="stylesheet" href="css/accidentMarkerCluster.css">
    <script src = "../../../../lib/d3/d3.js"></script>
    <script src = "../../../../lib/leaflet/leaflet.js"></script>
    <script src = "../../../../lib/leafletMarkerCluster/leaflet.markercluster-src.js"></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/v1.2.0/mapbox.js'></script>
  <style>
	body {
		margin: 0;
		padding: 0;
		overflow: hidden;
	}
  </style>
</head>
<body>
  <div id='map' class='dark'></div>
  <script type='text/javascript'>
  var map = L.mapbox.map('map', 'examples.map-y7l23tes')
      .setView([37.9, 121], 5);

      d3.csv('data/geo_google_accident.csv', function(data) {
            // 自定义图标
            var LeafIcon = L.Icon.extend({
                    options: {
                        iconSize:     [30, 40],
                        iconAnchor:   [15, 20],
                        popupAnchor:  [0, -30]
                    }
                });
            var iconSet = [];
            iconSet['dead'] = new LeafIcon({iconUrl: 'image/dead.png'});
            iconSet['hurt'] = new LeafIcon({iconUrl: 'image/hurt.png'});
            iconSet['damage'] = new LeafIcon({iconUrl: 'image/damage.png'});
            //以省份为索引，折叠数据
            var nestData = d3.nest()
                .key(function(d) { return d.accident; })
                .entries(data);
            // console.log(nestData);

            var markersClusters = [];
            //创建分组函数
            function defineCluster(clusterCss) {
                var clusterObj = {};
                clusterObj.maxClusterRadius = 100;
                clusterObj.iconCreateFunction = function (cluster) {
                    var childCount = cluster.getChildCount();

                    var c = clusterCss;
                    if (childCount < 10) {
                        c += '-small';
                    } else if (childCount < 70) {
                        c += '-medium';
                    } else {
                        c += '-large';
                    }

                    return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>', className:'marker-cluster ' + c, iconSize: new L.Point(40, 40) });
                }

                return L.markerClusterGroup(clusterObj);
            }
            //定义单个标点函数
            function defineMarker(d, cluster, markerIcon) {
                var title = '事故时间：' + d.time + '<br>' + '事故地点：' + d.place;
                var marker = L.marker(new L.LatLng(d.lat, d.lng), { title: title,  icon: markerIcon});
                
                marker.bindPopup(title);
                cluster.addLayer(marker);
            }

            nestData.forEach(function(d, i) {
                // 定义每组的坐标组
                markersClusters[i] = defineCluster(d.key);
                // console.log(markersClusters[i]);
                d.values.forEach(function(k) {
                    // console.log(k.time);
                    // 根据坐标类型选择图片
                    var iconPath = iconSet[k.accident];
                    // console.log(k);
                    // 定义每个坐标
                    defineMarker(k, markersClusters[i], iconPath);
                });
                // 添加一组坐标
                map.addLayer(markersClusters[i]);
            });           
            
        });
  </script>
</body>
</html>