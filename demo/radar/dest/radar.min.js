function renderTick(){function a(){d3.select("#radarTick").attr("cx",Math.sin(e*f)*(rInterpolateCircle*numMarkerCircle-5)).attr("cy",-Math.cos(e*f)*(rInterpolateCircle*numMarkerCircle-5)),f++}function b(){clearInterval(i)}var c=vizG.append("g").attr("id","radarTickGroup").attr("transform","translate("+svgwWidth/2+","+svgHeight/2+")");c.append("circle").attr("id","radarTick").attr("r","5").attr("cx",0).attr("cy",rInterpolateCircle*numMarkerCircle-5);var d=numYear,e=2*Math.PI/d,f=1,g=animateTime/d,h=g*d,i=window.setInterval(a,g);setTimeout(b,h)}function iniData(a){var b=d3.time.format("%Y/%m/%d");d3.time.format("%Y"),d3.time.format("%m"),d3.time.format("%d");a.forEach(function(a){a.standardTime=b.parse(a.date),a.totalValue=+a.totalValue,a.xPosition=+a.xPosition,a.yPosition=+a.yPosition});var c=d3.nest().key(function(a){return a.fundName}).entries(a);return c.forEach(function(a){a.values=_.sortBy(a.values,"standardTime")}),c}function renderData(a,b,c){var d=b.length-1,e=d3.range(d),f=(d3.extent(b,function(a){return a.totalValue}),d3.extent(b,function(a){return a.standardTime})),g=(d3.scale.linear().domain([0,9]).range([0,rInterpolateCircle*numMarkerCircle]),["2001/1/1","2016/12/31"]),h=caculateDateAngleExtent(g,f),i=(d3.time.scale().domain(f).range(h),h[0]/(2*Math.PI)*animateTime),j=d3.scale.linear().domain([0,animateTime]).range(["#000","#fff"]),k=(h[1]-h[0])/(2*Math.PI)*animateTime/b.length;a.append("g").attr("id","dataLineGroup").selectAll("line.dataLine").data(e).enter().append("line").classed(c,!0).classed("dataLine",!0).on("mouseover",function(a,c){showMouseTooltip(b[c+1].date,b[c+1].fundName,b[c+1].fundCode,b[c+1].totalValue)}).on("mouseout",function(a,c){hideMouseTooltip(b[c+1].fundName)}).transition().delay(function(a,b){return b*k+i}).attr("x1",function(a,c){return b[c].xPosition}).attr("y1",function(a,c){return b[c].yPosition}).attr("x2",function(a,c){return b[c+1].xPosition}).attr("y2",function(a,c){return b[c+1].yPosition}).style("stroke",j(i)).style("stroke-opacity",.8)}function renderCanvas(a){var b=d3.select("body").append("canvas").attr("width",1020).attr("height",1020),c=d3.select("canvas").node().getContext("2d");c.strokeStyle="black",c.lineWidth=1,a.forEach(function(a){return renderSingleCanvasCurve(b,c,a.values)})}function renderSingleCanvasCurve(a,b,c){var d,e=(d3.extent(c,function(a){return a.totalValue}),d3.extent(c,function(a){return a.standardTime})),f=(d3.scale.linear().domain([0,9]).range([0,rInterpolateCircle*numMarkerCircle]),["2001/1/1","2016/12/31"]),g=caculateDateAngleExtent(f,e),h=(d3.time.scale().domain(e).range(g),g[0]/(2*Math.PI)*animateTime,c.length),i=0;b.beginPath(),b.strokeStyle="gray",b.lineWidth=1,function j(){d=window.requestAnimationFrame(j,a),h>i?(xPosition_start=c[i].xPosition,yPosition_start=c[i].yPosition,xPosition_end=c[i+1].xPosition,yPosition_end=c[i+1].yPosition,b.moveTo(xPosition_start,yPosition_start),b.lineTo(xPosition_end,yPosition_end),b.stroke(),i++):window.cancelAnimationFrame(d)}()}function hightLightDataPath(){d3.select(this).classed("highLightLine",!0)}function unHightLightDataPath(){d3.select(this).classed("highLightLine",!1)}function hightLightDataLine(){var a=d3.select(this).attr("class"),b=a.split(" ");d3.selectAll("."+b[0]).classed("highLightLine",!0)}function unHightLightDataLine(){var a=d3.select(this).attr("class"),b=a.split(" ");d3.selectAll("."+b[0]).classed("highLightLine",!1)}function caculateDateAngleExtent(a,b){var c=d3.time.format("%Y/%m/%d"),d=c.parse(a[0]),e=c.parse(a[1]),f=e-d,g=b[0]-d,h=b[1]-d,i=2*Math.PI*g/f,j=2*Math.PI*h/f,k=[i,j];return k}function renderRadar(a,b,c){function d(d,e){function f(a,d){var e=i.append("g").attr("id","radarStructureCricleGroup").attr("transform","translate("+b/2+","+c/2+")"),f=d3.range(a);e.selectAll("circle.radarStructureCircle").data(f).enter().append("circle").attr("class","radarStructureCircle").attr("r",function(a,b){return(b+1)*d}),drawCircle(e,"radarStructureCircleOutBlack",{x:0,y:0},d*numMarkerCircle)}function g(a,d){var e=i.append("g").attr("id","radarStructureLineGroup").attr("transform","translate("+b/2+","+c/2+")"),f=d3.range(numLine),g=a*d,h=2*Math.PI/numLine;e.selectAll("line.radarStructureLine").data(f).enter().append("line").attr("class","radarStructureLine").attr("x1",function(a,b){return Math.cos(h*b)*d}).attr("y1",function(a,b){return-Math.sin(h*b)*d}).attr("x2",function(a,b){return+Math.cos(h*b)*g}).attr("y2",function(a,b){return-Math.sin(h*b)*g}),drawLine(e,"radarStructureLine",{x:0,y:-d},{x:0,y:d}),drawLine(e,"radarStructureLine",{x:-d,y:0},{x:d,y:0})}function h(a,d){var e=i.append("g").attr("id","radarStructureLineMarkerGroup").attr("transform","translate("+b/2+","+c/2+")"),f=d3.range(numYear),g=d3.range(12*numYear),h=2*Math.PI/numYear,j=2*Math.PI/(12*numYear);e.selectAll("line.radarStructureLineMarkerYear").data(f).enter().append("line").attr("class","radarStructureLineMarkerYear").attr("x1",function(a,b){return Math.sin(h*b)*d*numMarkerCircle}).attr("y1",function(a,b){return-Math.cos(h*b)*d*numMarkerCircle}).attr("x2",function(a,b){return+Math.sin(h*b)*(d*numMarkerCircle+8)}).attr("y2",function(a,b){return-Math.cos(h*b)*(d*numMarkerCircle+8)}),svg.append("g").attr("id","yearLabelGroupGroup").selectAll("g.yearLabelGroup").data(f).enter().append("g").attr("class","yearLabelGroup"),d3.selectAll("g.yearLabelGroup").data(f).append("text").attr("class","radarMarkerYearLabel").text(function(a,b){return startYear+b}).attr("transform",function(a,b){return"rotate("+360*b/numYear+")"}),d3.select("#yearLabelGroupGroup").attr("transform","translate("+(svgMargins.left+b/2)+","+(svgMargins.top+c/2)+")"),d3.selectAll("g.yearLabelGroup").data(f).attr("transform",function(a,b){return"translate("+Math.sin(h*b)*(d*numMarkerCircle+25)+","+-Math.cos(h*b)*(d*numMarkerCircle+25)+")"}),e.selectAll("line.radarStructureLineMarkerMonth").data(g).enter().append("line").attr("class","radarStructureLineMarkerMonth").attr("x1",function(a,b){return Math.sin(j*b)*d*numMarkerCircle}).attr("y1",function(a,b){return-Math.cos(j*b)*d*numMarkerCircle}).attr("x2",function(a,b){return+Math.sin(j*b)*(d*numMarkerCircle+5)}).attr("y2",function(a,b){return-Math.cos(j*b)*(d*numMarkerCircle+5)}),svg.append("g").attr("id","monthLabelGroupGroup").selectAll("g.monthLabelGroup").data(g).enter().append("g").attr("class","monthLabelGroup"),d3.selectAll("g.monthLabelGroup").data(g).append("text").attr("class","radarMarkerMonthLabel").text(function(a,b){return b%12+1}).attr("transform",function(a,b){return"rotate("+360*b/(12*numYear)+")"}),d3.select("#monthLabelGroupGroup").attr("transform","translate("+(svgMargins.left+b/2)+","+(svgMargins.top+c/2)+")"),d3.selectAll("g.monthLabelGroup").data(g).attr("transform",function(a,b){return"translate("+Math.sin(j*b)*(d*numMarkerCircle+10)+","+-Math.cos(j*b)*(d*numMarkerCircle+10)+")"})}var i=a.append("g").attr("id","radarStructureGroup");f(d,e),g(d,e),h(d,e)}function e(d,e){function f(a,b){var c=d3.range(a);g.selectAll("text.radarLabelRevenue").data(c).enter().append("text").attr("class","radarLabelRevenue").attr("x",0).attr("y",function(a,c){return-c*b+10}).text(function(a,b){return b+"￥"})}var g=a.append("g").attr("id","radarLabelGroup").attr("transform","translate("+b/2+","+c/2+")");f(d,e)}d(numCircle,rInterpolateCircle),e(numCircle,rInterpolateCircle)}function iniSvg(a,b){return svg=d3.select("body").append("svg").attr("id","svgCanvas").attr("width",a+svgMargins.right+svgMargins.left).attr("height",b+svgMargins.top+svgMargins.bottom),vizG=svg.append("g").attr("id","vizG").attr("transform","translate("+svgMargins.left+","+svgMargins.top+")")}function drawLine(a,b,c,d){a.append("line").attr("class",b).attr("x1",c.x).attr("y1",c.y).attr("x2",d.x).attr("y2",d.y)}function drawCircle(a,b,c,d){a.append("circle").attr("class",b).attr("x1",c.x).attr("y1",c.y).attr("r",d)}function drawLineWithData(a,b,c){}function caculateDateAngle(a,b){var c=d3.time.format("%Y/%m/%d"),d=(d3.time.format("%Y"),d3.time.format("%m"),d3.time.format("%d"),c.parse(a)),e=d3.extent(b,function(a){return a.standardTime}),f=d3.time.scale().domain(e).range([0,2*Math.PI]);console.log(f(d))}function caculateDateLength(a,b){var c=d3.time.format("%Y/%m/%d"),d=c.parse(a),e=c.parse(b),f=e-d;return console.log(f),f}function showMouseTooltipMiniMap(a,b,c,d,e){var f="."+c;d3.selectAll(f).classed("highLightLine",!0),mouseTooltip.style("opacity",1).style("z-index",10),mouseTooltip.html(generateMouseTipContent(b,c,d,e)).style("left",function(){var a=screen.width;return d3.event.pageX<a/2?d3.event.pageX+"px":d3.event.pageX-160+"px"}).style("top",d3.event.pageY+"px"),mouseTooltip.append("svg").attr("id","valueTrend").attr("width","150").attr("width","100").append("g").attr("id","trendContainer");var g=d3.extent(a);console.log(g);var h=d3.scale.linear().domain([0,11]).range([0,150]),i=d3.scale.linear().domain(g).range([0,100]),j=d3.svg.line().x(function(a,b){return h(b)}).y(function(a,b){return 100-i(a)}).interpolate("basis");d3.select("#trendContainer").selectAll("path.trend").data([a]).enter().append("path").attr("class","trend").attr("d",function(a){return j(a)}).attr("fill","none").attr("stroke","white").attr("stroke-width",2)}function showMouseTooltip(a,b,c,d){var e="."+b;d3.selectAll(e).classed("highLightLine",!0),mouseTooltip.style("opacity",1).style("z-index",10),mouseTooltip.html(generateMouseTipContent(a,b,c,d)).style("left",function(){var a=screen.width;return d3.event.pageX<a/2?d3.event.pageX+"px":d3.event.pageX-160+"px"}).style("top",d3.event.pageY+"px")}function hideMouseTooltip(a){var b="."+a;d3.selectAll(b).classed("highLightLine",!1),mouseTooltip.style("opacity",0)}function generateMouseTipContent(a,b,c,d){var e=a.split("/");return"<div id='dateTooltip'>"+e[0]+"年"+e[1]+"月"+e[2]+"日</div><div class='lineTooltip'><hr id='lineInTooltip'></div><div id='fundCodeTooltip'>代码："+c+"</div><div id='fundNameTooltip'>"+b+"</div><div class='lineTooltip'><hr id='lineInTooltip'></div><div id='totalValueTooltip'>累计收益："+d+"元</div>"}var svg,vizG,svgwWidth=1e3,svgHeight=1e3,svgMargins={top:10,right:10,bottom:10,left:10},mouseTooltip=d3.select("body").append("div").attr("class","mouseTooltip").style("opacity",0),numCircle=15,rInterpolateCircle=50,numYear=16,startYear=2001,numLine=36,numMarkerCircle=9,animateTime=2e4,sampleData=[d3.range(360).map(function(a){return{x:a,y:Math.round(20*Math.random()+80)}})],rawData,dataView;iniSvg(svgwWidth,svgHeight),vizG.append("text").attr("id","loading").attr("x",svgwWidth/2).attr("y",svgHeight/3).text("数据正在载入，请稍候......"),d3.csv("data/processedStockFundQuote.csv",function(a){rawData=a,dataView=iniData(rawData),renderRadar(vizG,svgwWidth,svgHeight),dataView.forEach(function(a){return renderData(vizG,a.values,a.key)}),d3.select("#loading").remove()});